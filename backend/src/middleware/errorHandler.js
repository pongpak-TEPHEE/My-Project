import { logger } from '../utils/logger.js'; // ‡πÄ‡∏≠‡∏≤ Logger ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏±‡∏ö!

export const globalErrorHandler = (err, req, res, next) => {
  // 1. üìù [Security Log] ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏° Dev ‡∏î‡∏π (‡∏°‡∏µ Stack Trace ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
  logger.error('Unhandled Exception Captured', {
    error_message: err.message,
    stack: err.stack,
    path: req.originalUrl,
    method: req.method,
    ip: req.ip,
    user_id: req.user ? req.user.user_id : 'Guest'
  });

  // 2. üõ°Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Environment ‡πÑ‡∏´‡∏ô (Dev ‡∏´‡∏£‡∏∑‡∏≠ Production)
  const isProduction = process.env.NODE_ENV === 'production';

  // 3. üõ°Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Production ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á Error ‡∏à‡∏£‡∏¥‡∏á ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ User ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
  const responseMessage = isProduction 
    ? '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' 
    : err.message; // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (Dev) ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ‡∏á‡πà‡∏≤‡∏¢‡πÜ

  // 4. ‡∏™‡πà‡∏á Error ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏™‡∏°‡∏≠ (Frontend ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON)
  res.status(err.status || 500).json({
    status: 'error',
    message: responseMessage,
    // ‡∏™‡πà‡∏á stack trace ‡πÑ‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô Dev ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    ...( !isProduction && { stack: err.stack } ) 
  });
};